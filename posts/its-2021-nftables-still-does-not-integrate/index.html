<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>It's 2021: nftables still does not integrate &#183; Zentria Blog</title>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/fonts.css>
<link rel=icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<link href rel=alternate type=application/rss+xml title="Zentria Blog">
<script src=/js/darkmode.js></script>
</head>
<body>
<nav class=nav>
<div class=nav-container>
<a href=/>
<h2 class=nav-title>Zentria Blog</h2>
</a>
<ul>
</ul>
</div>
</nav>
<div id=darkModeToggle onclick=toggleDarkMode()>
&#9680;
</div>
<main>
<div class=post>
<div class=post-info>
<span>Written by</span>
Mark V.
<br>
<span>on&nbsp;</span><time datetime="2021-05-29 19:25:17 +0300 +0300">May 29, 2021</time>
</div>
<h1 class=post-title>It's 2021: nftables still does not integrate</h1>
<div class=post-line></div>
<p>You probably have <a href=https://wiki.nftables.org/>seen it around</a> somewhere already, for example <a href=https://archive.is/Xeyqv>Debian trying hard to replace iptables</a> with it.<br>
Debian 10 (buster) shipped with it already, <a href=https://wiki.archlinux.org/title/nftables>Arch Linux wiki</a> provided (usable) examples for the adventurous back in 2014 etc.</p>
<p>(nftables is quite promising, don&rsquo;t get me wrong - I quite like it, because how much easier it is to use and integrate. This is rather a rant towards
other projects.)</p>
<p>HOWEVER, integrating it into existing solutions turns out to be VERY painful:</p>
<ol>
<li><a href=https://archive.is/uFhG3>Docker does not support it</a> - issue is still open</li>
<li>Kubernetes does not seem to support it. <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li>
<li>CNI does not support it yet (<a href=https://github.com/containernetworking/plugins/issues/519>https://github.com/containernetworking/plugins/issues/519</a>)</li>
<li>Unofficial <a href=https://archive.ph/ZW71R>CNI plugins for nftables</a> are poor quality at best. <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li>
<li>libvirt does not support nftables (directly)</li>
</ol>
<h2 id=iptables-nft-compatibility-layer-problems>iptables-nft compatibility layer problems</h2>
<p><code>iptables-nft</code> does not support all features what legacy <code>iptables</code> does. Few examples:</p>
<h3 id=libvirt>libvirt:</h3>
<pre tabindex=0><code>Error starting network 'default': internal error: Failed to apply firewall rules /usr/bin/iptables -w --table filter --insert LIBVIRT_INP --in-interface virbr0 --protocol tcp --destination-port 67 --jump ACCEPT:
iptables v1.8.7 (nf_tables): unknown option &quot;--destination-port&quot;
Try `iptables -h' or 'iptables --help' for more information.
</code></pre><h3 id=docker>Docker:</h3>
<pre tabindex=0><code>time=&quot;2021-05-29T18:05:01.787346850+03:00&quot; level=warning msg=&quot;could not create bridge network for id a443ac2c9035cec5bafe7205015d6c308a09fcdc25b1a4bb9f537797a900df81 bridge name docker0 while booting up from persistent state: Failed to program NAT chain: Failed to inject DOCKER in PREROUTING chain: iptables failed: iptables -t nat -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER: iptables v1.8.7 (nf_tables): Couldn't load match `addrtype':No such file or directory\n\nTry `iptables -h' or 'iptables --help' for more information.\n (exit status 2)&quot;
</code></pre><h2 id=workarounds>Workarounds</h2>
<h3 id=libvirt-1>Libvirt:</h3>
<p>Use <a href=https://archive.ph/uXe1v>firewalld</a> perhaps? I could not get it working with default network though (NAT, <code>192.168.122.0/24</code> - see compatibility layer problems section).</p>
<h3 id=docker-1>Docker:</h3>
<p>There are few solutions around, like <a href=https://archive.is/MHBu3>https://archive.is/MHBu3</a> and <a href=https://archive.is/bqKHl>https://archive.is/bqKHl</a>, but this involves disabling
Docker&rsquo;s iptables integration, making use of managed networks (<code>docker network create &lt;name></code>) painful.</p>
<p>Technically could work this around by writing a events listener for Docker or using a plugin (probably?)</p>
<p>Note that using <a href=https://archive.ph/uXe1v>firewalld</a> won&rsquo;t save you with Docker - it wants to insert custom rules via <a href=https://archive.is/t3Pyl>the <code>--direct</code> interface</a></p>
<h1 id=in-conclusion>In conclusion</h1>
<p>nftables works, but integrating it into existing solutions is still painful / impossible. Let&rsquo;s revisit this topic in 2022 perhaps?</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>I&rsquo;m not entirely sure. It isn&rsquo;t like written into stone or something, but there are discussions around the internet which imply that it does not:</p>
<ul>
<li><a href=https://archive.is/vgJPL>https://archive.is/vgJPL</a></li>
<li><a href=https://archive.is/q55MZ>https://archive.is/q55MZ</a></li>
<li><a href=https://archive.is/fj5A0#ensure-iptables-tooling-does-not-use-the-nftables-backend>https://archive.is/fj5A0#ensure-iptables-tooling-does-not-use-the-nftables-backend</a></li>
<li><a href=https://archive.is/zrnSx>https://archive.is/zrnSx</a></li>
</ul>
&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li>
<li id=fn:2 role=doc-endnote>
<p>Inserting identical jump rule multiple times. See <a href=https://gist.github.com/mikroskeem/5aaef53bd500435bbb1f900e7a68d627>this gist</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<div class=pagination>
<a href=/posts/nixos-cgroupsv2/ class="left arrow">&#8592;</a>
<a href=/posts/container-bind-mount-pitfalls-dns/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a>
</div>
</main>
<footer>
<span>
&copy; <time datetime="2022-10-20 15:40:59.688427549 +0000 UTC m=+0.048683216">2022</time> . Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.
</span>
</footer>
</body>
</html>